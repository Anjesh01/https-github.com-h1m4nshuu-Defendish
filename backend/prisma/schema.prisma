generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  isVerified    Boolean   @default(false)
  otp           String?
  otpExpiresAt  DateTime?
  allergens     String?   // JSON string of user's allergens
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  profiles      Profile[]
  
  @@map("users")
}

model Profile {
  id              String    @id @default(uuid())
  userId          String
  name            String
  dateOfBirth     DateTime?
  bloodGroup      String?
  height          Float?    // in cm
  weight          Float?    // in kg
  relation        String    // self, child, parent, other
  allergies       String?   // JSON string of allergens
  photoUrl        String?   // profile photo URL or avatar identifier
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products        Product[]
  healthRecords   HealthRecord[]
  incidents       HealthIncident[]
  
  @@map("profiles")
}

model Product {
  id                  String    @id @default(uuid())
  profileId           String
  name                String
  barcode             String?
  ingredients         String?   // JSON string of ingredients
  rawIngredients      String
  manufacturingDate   DateTime?
  expiryDate          DateTime?
  dosage              String?
  storageInstructions String?
  imageUrl            String?
  suitabilityStatus   String    @default("not_checked") // not_checked, safe, unsafe
  aiRecommendation    String?   // JSON string
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  profile             Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  incidents           HealthIncident[]
  
  @@index([profileId, expiryDate])
  @@map("products")
}

model HealthRecord {
  id              String    @id @default(uuid())
  profileId       String
  fileUrl         String
  fileType        String    // prescription, lab_report, checkup
  extractedData   String?   // JSON string
  allergies       String?   // JSON string of detected allergies
  diagnoses       String?   // JSON string of detected diagnoses
  medications     String?   // JSON string of detected medications
  uploadedAt      DateTime  @default(now())
  
  profile         Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@map("health_records")
}

model HealthIncident {
  id              String    @id @default(uuid())
  profileId       String
  productId       String?
  symptoms        String
  severity        String    // mild, moderate, severe
  timestamp       DateTime  @default(now())
  actionTaken     String?
  
  profile         Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  product         Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  @@map("health_incidents")
}
